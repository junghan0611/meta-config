#+title:      Implementation Architecture: í‘œì¤€ í”„ë¡œí† ì½œ ê¸°ë°˜ êµ¬í˜„
#+date:       [2025-10-14 Tue 14:10]
#+filetags:   :meta:implementation:architecture:acp:mcp:a2a:
#+identifier: 20251014T141000
#+export_file_name: 20251014T141000-implementation.md

* Implementation Architecture: í‘œì¤€ í”„ë¡œí† ì½œ ê¸°ë°˜ êµ¬í˜„

**ë²„ì „**: 1.0.0  
**ìƒíƒœ**: ğŸ› ï¸ DESIGN  
**ì—…ë°ì´íŠ¸**: 2025-10-14

#+begin_quote
"Standards-based, production-ready, yet personal"
"í‘œì¤€ ê¸°ë°˜, í”„ë¡œë•ì…˜ í’ˆì§ˆ, ê·¸ëŸ¬ë‚˜ ê°œì¸ìš©"
#+end_quote

** ğŸ—ï¸ ì „ì²´ ì•„í‚¤í…ì²˜

*** ê³„ì¸µë³„ í”„ë¡œí† ì½œ ë§µí•‘

#+begin_src
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 5: User Interface                        â”‚
â”‚  - Emacs/Org-mode                               â”‚
â”‚  - agent-shell.el (ACP Client)                 â”‚
â”‚  - Natural Language Input                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†• ACP (JSON-RPC 2.0)
                       stdio / TCP:5000
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: Meta Agent                            â”‚
â”‚  - Claude Code (via ACP)                        â”‚
â”‚  - Intent Recognition                           â”‚
â”‚  - Domain Routing                               â”‚
â”‚  - Result Aggregation                           â”‚
â”‚  - Memory: ~/claude-memory/                    â”‚
â”‚  - Config: CLAUDE.md                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†• A2A (JSON-RPC 2.0)
                       HTTP:8080-8089
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Domain Agents (A2A Servers)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Family-Config Agent (Port 8080)          â”‚  â”‚
â”‚  â”‚ - Agent Card: family.* capabilities       â”‚  â”‚
â”‚  â”‚ - A2A Server (express/fastapi)           â”‚  â”‚
â”‚  â”‚ - MCP Client (ë„êµ¬ í˜¸ì¶œ)                  â”‚  â”‚
â”‚  â”‚ - Memory: ~/org/family/                  â”‚  â”‚
â”‚  â”‚ - Config: FAMILY.md                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Work-Config Agent (Port 8081) [ë¯¸ë˜]     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Health-Config Agent (Port 8082) [ë¯¸ë˜]   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†• MCP (JSON-RPC 2.0)
                       stdio / HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: MCP Servers (Tools)                   â”‚
â”‚  - mcp__web_search                             â”‚
â”‚  - mcp__n8n                                    â”‚
â”‚  - mcp__playwright                             â”‚
â”‚  - mcp__git                                    â”‚
â”‚  - mcp__supabase                               â”‚
â”‚  - mcp__google_calendar                        â”‚
â”‚  - mcp__filesystem                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†• HTTP/APIs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: External Services                     â”‚
â”‚  - Google (Flights, Calendar, Drive)           â”‚
â”‚  - Booking.com, Airlines, Banks...             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+end_src

** ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°

*** ì „ì²´ ì‹œìŠ¤í…œ

#+begin_src
~/repos/gh/
â”œâ”€â”€ meta-config/                      # ì•„í‚¤í…ì²˜ ë¬¸ì„œ (ì´ í”„ë¡œì íŠ¸)
â”‚   â”œâ”€â”€ README.org                    # ê³„ì¸µì  ì—ì´ì „íŠ¸ ê°œë…
â”‚   â”œâ”€â”€ docs/
â”‚   â”‚   â”œâ”€â”€ delegation-protocol.org  # A2A ê¸°ë°˜ ìœ„ì„ í”„ë¡œí† ì½œ
â”‚   â”‚   â”œâ”€â”€ protocol-standards-analysis.org  # ACP/MCP/A2A ë¶„ì„
â”‚   â”‚   â””â”€â”€ implementation-architecture.org  # ì´ ë¬¸ì„œ
â”‚   â”œâ”€â”€ examples/                     # ì‹œë‚˜ë¦¬ì˜¤ ì˜ˆì œ
â”‚   â””â”€â”€ schemas/                      # JSON ìŠ¤í‚¤ë§ˆ
â”‚
â”œâ”€â”€ family-config/                    # Family Domain Agent (A2A Server)
â”‚   â”œâ”€â”€ FAMILY.md                     # Agent ì§€ì¹¨ì„œ
â”‚   â”œâ”€â”€ README.md                     # í”„ë¡œì íŠ¸ ì†Œê°œ
â”‚   â”œâ”€â”€ src/                          # ì†ŒìŠ¤ ì½”ë“œ
â”‚   â”‚   â”œâ”€â”€ a2a-server/              # A2A ì„œë²„ êµ¬í˜„
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts            # Express/Fastapi ì„œë²„
â”‚   â”‚   â”‚   â”œâ”€â”€ agent-card.json      # Agent Card
â”‚   â”‚   â”‚   â”œâ”€â”€ task-processor.ts    # ì‘ì—… ì²˜ë¦¬
â”‚   â”‚   â”‚   â””â”€â”€ routes/              # API ë¼ìš°íŠ¸
â”‚   â”‚   â”œâ”€â”€ mcp-client/              # MCP í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ web-search.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ calendar.ts
â”‚   â”‚   â”‚   â””â”€â”€ filesystem.ts
â”‚   â”‚   â””â”€â”€ domain/                   # ë„ë©”ì¸ ë¡œì§
â”‚   â”‚       â”œâ”€â”€ travel/
â”‚   â”‚       â”œâ”€â”€ finance/
â”‚   â”‚       â””â”€â”€ events/
â”‚   â”œâ”€â”€ memory/                       # PARA ë©”ëª¨ë¦¬
â”‚   â”œâ”€â”€ templates/                    # Org í…œí”Œë¦¿
â”‚   â””â”€â”€ tests/                        # í…ŒìŠ¤íŠ¸
â”‚
â””â”€â”€ claude-config/                    # Meta Agent (ACP Client)
    â”œâ”€â”€ CLAUDE.md
    â””â”€â”€ memory/

~/.config/claude-code/                # Claude Code ì„¤ì •
    â””â”€â”€ mcp/                          # MCP ì„œë²„ ì„¤ì •

~/org/family/                         # ì‹¤ì œ ë°ì´í„° (Private)
#+end_src

** ğŸ”§ êµ¬í˜„ ìƒì„¸

*** 1. Family-Config A2A Server

**** Agent Card (ëŠ¥ë ¥ ê´‘ê³ )

#+begin_src json
// family-config/src/a2a-server/agent-card.json
{
  "agentId": "family-config-agent",
  "version": "1.0.0",
  "name": "Family Life Management Agent",
  "description": "AI agent for managing family life: travel, finance, education, events",
  
  "author": {
    "name": "Junghan Kim",
    "email": "junghanacs@gmail.com",
    "url": "https://notes.junghanacs.com"
  },
  
  "license": "MIT",
  
  "capabilities": [
    {
      "id": "family.travel.plan",
      "name": "Travel Planning",
      "description": "Plan family trips with budget optimization and MCP-powered research",
      "version": "1.0.0",
      "category": "planning",
      "tags": ["travel", "family", "budget", "planning"],
      
      "inputSchema": {
        "type": "object",
        "properties": {
          "destination": {
            "type": "string",
            "description": "Travel destination"
          },
          "dates": {
            "type": "object",
            "properties": {
              "start": { "type": "string", "format": "date" },
              "end": { "type": "string", "format": "date" }
            },
            "required": ["start", "end"]
          },
          "budget": {
            "type": "number",
            "description": "Total budget in KRW"
          },
          "participants": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "role": {
                  "type": "string",
                  "enum": ["dad", "mom", "child", "infant"]
                },
                "age": { "type": "number" },
                "name": { "type": "string" },
                "specialNeeds": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              },
              "required": ["role"]
            }
          },
          "preferences": {
            "type": "object",
            "properties": {
              "accommodationType": { "type": "string" },
              "activities": {
                "type": "array",
                "items": { "type": "string" }
              },
              "dietaryRestrictions": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
          }
        },
        "required": ["destination", "dates", "budget", "participants"]
      },
      
      "outputSchema": {
        "type": "object",
        "properties": {
          "filePath": { "type": "string" },
          "summary": {
            "type": "object",
            "properties": {
              "totalCost": { "type": "number" },
              "withinBudget": { "type": "boolean" },
              "flightsFound": { "type": "number" },
              "accommodationsFound": { "type": "number" }
            }
          },
          "nextActions": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "action": { "type": "string" },
                "deadline": { "type": "string", "format": "date-time" },
                "estimatedCost": { "type": "number" }
              }
            }
          }
        }
      },
      
      "estimatedDuration": 45,
      "requiresHumanApproval": false,
      "mcpToolsUsed": ["web_search", "calendar", "filesystem"]
    },
    
    {
      "id": "family.events.remind",
      "name": "Event Reminders",
      "description": "Track and remind family events (birthdays, ceremonies)",
      "version": "1.0.0",
      "category": "monitoring",
      "tags": ["events", "reminders", "ceremonies"],
      
      "inputSchema": {
        "type": "object",
        "properties": {
          "lookAheadDays": {
            "type": "number",
            "default": 7,
            "description": "How many days to look ahead"
          }
        }
      },
      
      "outputSchema": {
        "type": "object",
        "properties": {
          "upcomingEvents": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "date": { "type": "string", "format": "date" },
                "type": { "type": "string" },
                "person": { "type": "string" },
                "suggestedGift": { "type": "number" }
              }
            }
          }
        }
      },
      
      "estimatedDuration": 5,
      "requiresHumanApproval": false,
      "mcpToolsUsed": ["filesystem", "calendar"]
    },
    
    {
      "id": "family.finance.track",
      "name": "Finance Tracking",
      "description": "Track family expenses and generate budget reports",
      "version": "1.0.0",
      "category": "tracking",
      "tags": ["finance", "budget", "expenses", "ledger"],
      
      "inputSchema": {
        "type": "object",
        "properties": {
          "period": {
            "type": "string",
            "enum": ["daily", "weekly", "monthly", "yearly"]
          },
          "category": { "type": "string" }
        },
        "required": ["period"]
      },
      
      "outputSchema": {
        "type": "object",
        "properties": {
          "report": { "type": "string" },
          "totalSpent": { "type": "number" },
          "budgetStatus": { "type": "string" },
          "warnings": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      },
      
      "estimatedDuration": 10,
      "requiresHumanApproval": false,
      "mcpToolsUsed": ["filesystem", "supabase"]
    },
    
    {
      "id": "family.education.schedule",
      "name": "Education Scheduling",
      "description": "Manage children's education schedules and track progress",
      "version": "1.0.0",
      "category": "planning",
      "tags": ["education", "schedule", "children"],
      
      "inputSchema": {
        "type": "object",
        "properties": {
          "child": { "type": "string" },
          "subject": { "type": "string" },
          "dateRange": {
            "type": "object",
            "properties": {
              "start": { "type": "string", "format": "date" },
              "end": { "type": "string", "format": "date" }
            }
          }
        },
        "required": ["child"]
      },
      
      "outputSchema": {
        "type": "object",
        "properties": {
          "schedule": { "type": "string" },
          "conflicts": {
            "type": "array",
            "items": { "type": "string" }
          },
          "calendarSynced": { "type": "boolean" }
        }
      },
      
      "estimatedDuration": 15,
      "requiresHumanApproval": false,
      "mcpToolsUsed": ["filesystem", "calendar"]
    }
  ],
  
  "supportedModalities": ["text", "markdown", "json", "org-mode"],
  
  "authentication": {
    "type": "bearer",
    "required": false,
    "description": "Optional for personal use, required for multi-user"
  },
  
  "rateLimit": {
    "requestsPerMinute": 10,
    "concurrentTasks": 3,
    "maxTaskDuration": 300
  },
  
  "endpoints": {
    "agentCard": "GET http://localhost:8080/agent-card",
    "createTask": "POST http://localhost:8080/tasks",
    "getTask": "GET http://localhost:8080/tasks/{taskId}",
    "cancelTask": "DELETE http://localhost:8080/tasks/{taskId}"
  },
  
  "healthCheck": "GET http://localhost:8080/health"
}
#+end_src

**** A2A Server êµ¬í˜„ (TypeScript)

#+begin_src typescript
// family-config/src/a2a-server/server.ts
import express, { Express, Request, Response } from 'express';
import { MCPClient } from '@modelcontextprotocol/sdk/client/index.js';
import agentCard from './agent-card.json';

const app: Express = express();
app.use(express.json());

// Task ì €ì¥ì†Œ
const tasks = new Map<string, Task>();

// MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const mcpClient = new MCPClient({
  name: 'family-config-agent',
  version: '1.0.0'
});

// 1. Agent Card ì œê³µ
app.get('/agent-card', (req: Request, res: Response) => {
  res.json(agentCard);
});

// 2. Health Check
app.get('/health', (req: Request, res: Response) => {
  res.json({
    status: 'healthy',
    uptime: process.uptime(),
    mcpConnections: mcpClient.getConnections().length
  });
});

// 3. Task ìƒì„±
app.post('/tasks', async (req: Request, res: Response) => {
  const { taskId, capability, input, preferences } = req.body;
  
  // ìœ íš¨ì„± ê²€ì¦
  const capabilityDef = agentCard.capabilities.find(
    c => c.id === capability
  );
  
  if (!capabilityDef) {
    return res.status(404).json({
      error: 'CAPABILITY_NOT_FOUND',
      message: `Capability '${capability}' not supported`
    });
  }
  
  // Task ì €ì¥
  const task: Task = {
    taskId,
    capability,
    input,
    preferences,
    status: 'accepted',
    createdAt: new Date().toISOString(),
    estimatedDuration: capabilityDef.estimatedDuration
  };
  tasks.set(taskId, task);
  
  // ì¦‰ì‹œ ìˆ˜ë½ ì‘ë‹µ (202 Accepted)
  res.status(202).json({
    taskId,
    status: 'accepted',
    estimatedDuration: task.estimatedDuration,
    message: `Task ${capability} accepted`
  });
  
  // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
  processTaskAsync(task).catch(err => {
    task.status = 'failed';
    task.error = err.message;
  });
});

// 4. Task ìƒíƒœ ì¡°íšŒ
app.get('/tasks/:taskId', (req: Request, res: Response) => {
  const task = tasks.get(req.params.taskId);
  
  if (!task) {
    return res.status(404).json({
      error: 'TASK_NOT_FOUND'
    });
  }
  
  res.json({
    taskId: task.taskId,
    status: task.status,
    progress: task.progress || 0,
    result: task.result,
    error: task.error
  });
});

// 5. Task ì·¨ì†Œ
app.delete('/tasks/:taskId', (req: Request, res: Response) => {
  const task = tasks.get(req.params.taskId);
  
  if (!task) {
    return res.status(404).json({ error: 'TASK_NOT_FOUND' });
  }
  
  if (task.status === 'completed' || task.status === 'failed') {
    return res.status(409).json({
      error: 'TASK_ALREADY_TERMINAL',
      message: 'Cannot cancel completed or failed task'
    });
  }
  
  task.status = 'cancelled';
  res.json({ taskId: task.taskId, status: 'cancelled' });
});

// ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ì²˜ë¦¬
async function processTaskAsync(task: Task) {
  task.status = 'in_progress';
  task.progress = 0;
  
  try {
    switch (task.capability) {
      case 'family.travel.plan':
        await processTravelPlanning(task);
        break;
      case 'family.events.remind':
        await processEventReminders(task);
        break;
      case 'family.finance.track':
        await processFinanceTracking(task);
        break;
      default:
        throw new Error(`Unknown capability: ${task.capability}`);
    }
    
    task.status = 'completed';
    task.progress = 1.0;
  } catch (error) {
    task.status = 'failed';
    task.error = error.message;
  }
}

// ì—¬í–‰ ê³„íš ì²˜ë¦¬
async function processTravelPlanning(task: Task) {
  const { destination, dates, budget, participants } = task.input;
  
  // Progress: 10%
  task.progress = 0.1;
  
  // 1. MCPë¡œ í•­ê³µê¶Œ ê²€ìƒ‰
  const flights = await mcpClient.callTool({
    name: 'web_search',
    arguments: {
      query: `${destination} í•­ê³µê¶Œ ${dates.start} ì™•ë³µ ${participants.length}ëª…`,
      limit: 10
    }
  });
  
  // Progress: 40%
  task.progress = 0.4;
  
  // 2. MCPë¡œ ìˆ™ë°• ê²€ìƒ‰
  const accommodations = await mcpClient.callTool({
    name: 'web_search',
    arguments: {
      query: `${destination} ê°€ì¡± ìˆ™ì†Œ ${dates.start}`,
      limit: 15
    }
  });
  
  // Progress: 70%
  task.progress = 0.7;
  
  // 3. ê³¼ê±° ì—¬í–‰ íŒ¨í„´ ë¶„ì„ (MCP filesystem)
  const pastTrips = await mcpClient.request({
    method: 'resources/read',
    params: { uri: 'file://~/org/family/travel/history/' }
  });
  
  // 4. Org íŒŒì¼ ìƒì„±
  const orgContent = generateTripPlanningOrg({
    destination,
    dates,
    budget,
    participants,
    flights,
    accommodations,
    pastTrips
  });
  
  const filePath = `~/org/family/travel/${dates.start.replace(/-/g, '')}-${destination}.org`;
  
  await mcpClient.callTool({
    name: 'write_file',
    arguments: {
      path: filePath,
      content: orgContent
    }
  });
  
  // Progress: 90%
  task.progress = 0.9;
  
  // 5. Calendar ë™ê¸°í™”
  await mcpClient.callTool({
    name: 'google_calendar_create_event',
    arguments: {
      title: `ê°€ì¡± ì—¬í–‰: ${destination}`,
      start: dates.start,
      end: dates.end,
      description: `ì˜ˆì‚°: ${budget.toLocaleString()}ì›`
    }
  });
  
  // ì™„ë£Œ
  task.result = {
    filePath,
    summary: {
      totalCost: 2850000,  // ê³„ì‚°ëœ ê°’
      withinBudget: true,
      flightsFound: flights.length,
      accommodationsFound: accommodations.length
    },
    nextActions: [
      {
        action: 'book_flight',
        deadline: '2025-04-30T23:59:59+09:00',
        estimatedCost: 680000
      }
    ]
  };
}

// ì„œë²„ ì‹œì‘
const PORT = 8080;
app.listen(PORT, () => {
  console.log(`Family-Config A2A Server running on http://localhost:${PORT}`);
  console.log(`Agent Card: http://localhost:${PORT}/agent-card`);
});

export default app;
#+end_src

**** íŒ¨í‚¤ì§€ êµ¬ì¡°

#+begin_src json
// family-config/package.json
{
  "name": "family-config-agent",
  "version": "1.0.0",
  "description": "AI Agent for Family Life Management (A2A Server)",
  "main": "dist/server.js",
  
  "scripts": {
    "dev": "tsx watch src/a2a-server/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "jest"
  },
  
  "dependencies": {
    "express": "^4.18.2",
    "@modelcontextprotocol/sdk": "^0.6.0",
    "zod": "^3.22.0"
  },
  
  "devDependencies": {
    "typescript": "^5.3.0",
    "tsx": "^4.7.0",
    "@types/express": "^4.17.21"
  }
}
#+end_src

*** 2. Meta Agent (Claude Code)

**** A2A Client êµ¬í˜„

#+begin_src typescript
// claude-config/src/a2a-client.ts
import axios from 'axios';

class A2AClient {
  private baseUrl: string;
  
  constructor(agentUrl: string) {
    this.baseUrl = agentUrl;
  }
  
  // Agent ëŠ¥ë ¥ ì¡°íšŒ
  async getAgentCard() {
    const response = await axios.get(`${this.baseUrl}/agent-card`);
    return response.data;
  }
  
  // Task ìƒì„±
  async createTask(capability: string, input: any, preferences?: any) {
    const taskId = `task_${Date.now()}`;
    
    const response = await axios.post(`${this.baseUrl}/tasks`, {
      taskId,
      capability,
      input,
      preferences
    });
    
    return { taskId, ...response.data };
  }
  
  // Task ìƒíƒœ ì¡°íšŒ
  async getTaskStatus(taskId: string) {
    const response = await axios.get(`${this.baseUrl}/tasks/${taskId}`);
    return response.data;
  }
  
  // Task ì™„ë£Œ ëŒ€ê¸° (polling)
  async waitForCompletion(taskId: string, pollInterval = 2000) {
    return new Promise((resolve, reject) => {
      const poll = setInterval(async () => {
        try {
          const status = await this.getTaskStatus(taskId);
          
          if (status.status === 'completed') {
            clearInterval(poll);
            resolve(status.result);
          } else if (status.status === 'failed') {
            clearInterval(poll);
            reject(new Error(status.error));
          }
          
          // Progress ë¡œê·¸
          console.log(`Task ${taskId}: ${status.progress * 100}%`);
        } catch (error) {
          clearInterval(poll);
          reject(error);
        }
      }, pollInterval);
    });
  }
}

// ì‚¬ìš© ì˜ˆì‹œ
const familyAgent = new A2AClient('http://localhost:8080');

// 1. Agent ëŠ¥ë ¥ í™•ì¸
const card = await familyAgent.getAgentCard();
console.log('Family Agent Capabilities:', card.capabilities.map(c => c.id));

// 2. ì—¬í–‰ ê³„íš ì‘ì—… ìƒì„±
const { taskId } = await familyAgent.createTask('family.travel.plan', {
  destination: 'ì œì£¼ë„',
  dates: { start: '2025-07-20', end: '2025-07-27' },
  budget: 3000000,
  participants: [
    { role: 'dad' },
    { role: 'mom' },
    { role: 'child', age: 8 },
    { role: 'child', age: 5 }
  ]
});

// 3. ì™„ë£Œ ëŒ€ê¸°
const result = await familyAgent.waitForCompletion(taskId);
console.log('Travel plan created:', result.filePath);
#+end_src

*** 3. Agent ê²€ìƒ‰ ë° ë¼ìš°íŒ…

**** Meta Agentì˜ Agent Registry

#+begin_src typescript
// claude-config/src/agent-registry.ts
interface AgentRegistryEntry {
  agentId: string;
  url: string;
  agentCard: any;
  lastHealthCheck: Date;
  healthy: boolean;
}

class AgentRegistry {
  private agents: Map<string, AgentRegistryEntry> = new Map();
  
  // Agent ë“±ë¡
  async register(agentUrl: string) {
    const client = new A2AClient(agentUrl);
    const agentCard = await client.getAgentCard();
    
    this.agents.set(agentCard.agentId, {
      agentId: agentCard.agentId,
      url: agentUrl,
      agentCard,
      lastHealthCheck: new Date(),
      healthy: true
    });
    
    console.log(`Registered agent: ${agentCard.agentId}`);
  }
  
  // Capabilityë¡œ Agent ì°¾ê¸°
  findAgentByCapability(capability: string): AgentRegistryEntry | null {
    for (const [_, agent] of this.agents) {
      const hasCapability = agent.agentCard.capabilities.some(
        (c: any) => c.id === capability
      );
      
      if (hasCapability && agent.healthy) {
        return agent;
      }
    }
    
    return null;
  }
  
  // Health check (ì£¼ê¸°ì  ì‹¤í–‰)
  async healthCheck() {
    for (const [agentId, agent] of this.agents) {
      try {
        const response = await axios.get(`${agent.url}/health`, {
          timeout: 5000
        });
        
        agent.healthy = response.status === 200;
        agent.lastHealthCheck = new Date();
      } catch (error) {
        agent.healthy = false;
        console.warn(`Agent ${agentId} health check failed`);
      }
    }
  }
}

// Meta Agent ì´ˆê¸°í™”
const registry = new AgentRegistry();
await registry.register('http://localhost:8080');  // Family-Config
await registry.register('http://localhost:8081');  // Work-Config (ë¯¸ë˜)

// Health check ìŠ¤ì¼€ì¤„ë§
setInterval(() => registry.healthCheck(), 60000);  // 1ë¶„ë§ˆë‹¤
#+end_src

**** ë„ë©”ì¸ ë¼ìš°íŒ…

#+begin_src typescript
// claude-config/src/domain-router.ts
class DomainRouter {
  constructor(private registry: AgentRegistry) {}
  
  async route(userRequest: string): Promise<any> {
    // 1. Intent ë¶„ì„
    const intent = await this.analyzeIntent(userRequest);
    
    // 2. Capability ê²°ì •
    const capability = this.mapIntentToCapability(intent);
    
    // 3. Agent ê²€ìƒ‰
    const agent = this.registry.findAgentByCapability(capability);
    
    if (!agent) {
      throw new Error(`No agent found for capability: ${capability}`);
    }
    
    // 4. Task ìœ„ì„
    const client = new A2AClient(agent.url);
    const { taskId } = await client.createTask(
      capability,
      intent.parameters,
      intent.preferences
    );
    
    // 5. ì™„ë£Œ ëŒ€ê¸°
    const result = await client.waitForCompletion(taskId);
    
    return result;
  }
  
  private async analyzeIntent(userRequest: string) {
    // Claude APIë¡œ intent ë¶„ì„
    // "ì—¬ë¦„ì— ì œì£¼ë„ ê°€ì¡± ì—¬í–‰ ê³„íš" â†’
    // {
    //   domain: "family",
    //   taskType: "travel",
    //   action: "plan",
    //   parameters: { destination: "ì œì£¼ë„", ... }
    // }
  }
  
  private mapIntentToCapability(intent: any): string {
    return `${intent.domain}.${intent.taskType}.${intent.action}`;
    // â†’ "family.travel.plan"
  }
}
#+end_src

** ğŸ”„ ì™„ì „í•œ íë¦„ ì˜ˆì‹œ

*** ì‹œë‚˜ë¦¬ì˜¤: ì—¬í–‰ ê³„íš

#+begin_src
[1] User (Emacs)
    â†“ ACP: agent/execute
    "ì—¬ë¦„ì— ì œì£¼ë„ ê°€ì¡± ì—¬í–‰ ê³„íš ì¢€ ë„ì™€ì¤˜"
    
[2] Meta Agent (Claude Code)
    â†“ Intent Analysis
    â†’ domain: "family"
    â†’ capability: "family.travel.plan"
    
    â†“ Agent Discovery
    â†’ Registryì—ì„œ Family-Config Agent ì°¾ê¸°
    â†’ http://localhost:8080/agent-card í™•ì¸
    
    â†“ A2A: POST /tasks
    {
      taskId: "task_20251014_001",
      capability: "family.travel.plan",
      input: { destination: "ì œì£¼ë„", ... }
    }
    
[3] Family-Config Agent
    â† A2A: 202 Accepted
    
    â†“ Task Processing (ë°±ê·¸ë¼ìš´ë“œ)
    
    â†“ MCP: web_search (í•­ê³µê¶Œ)
    â† 5ê°œ ì˜µì…˜
    
    â†“ MCP: web_search (ìˆ™ë°•)
    â† 12ê°œ ì˜µì…˜
    
    â†“ MCP: filesystem (ê³¼ê±° ì—¬í–‰)
    â† 2024ë…„ ë¶€ì‚° ì—¬í–‰ ë°ì´í„°
    
    â†“ MCP: write_file (Org íŒŒì¼ ìƒì„±)
    â† ~/org/family/travel/20250720-jeju.org
    
    â†“ MCP: calendar (Google Calendar)
    â† Event created
    
    â†“ A2A: Task completed
    
[4] Meta Agent (Polling)
    â† A2A: GET /tasks/{id}
    â† status: completed
    
    â†“ Result Integration
    
    â†“ ACP: Result to Emacs
    
[5] User (Emacs)
    â† "ì—¬í–‰ ê³„íšì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
    â† File opened: ~/org/family/travel/20250720-jeju.org
#+end_src

** ğŸ› ï¸ êµ¬í˜„ ë¡œë“œë§µ

*** Phase 1: MCP í†µí•© (í˜„ì¬)

- [X] Family-Config í…œí”Œë¦¿ êµ¬ì¶•
- [ ] MCP í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
  - [ ] web_search ì—°ë™
  - [ ] filesystem ì—°ë™
  - [ ] calendar ì—°ë™
- [ ] ë‹¨ì¼ ì‘ì—… ì‹¤í–‰ (ìˆ˜ë™)

*** Phase 2: A2A ì„œë²„ êµ¬í˜„ (2025 Q4)

- [ ] Agent Card ì •ì˜
- [ ] A2A Server ê¸°ë³¸ êµ¬ì¡°
  - [ ] Express/Fastapi ì„œë²„
  - [ ] Task ê´€ë¦¬ (CRUD)
  - [ ] ë¹„ë™ê¸° ì²˜ë¦¬
- [ ] 1ê°œ capability êµ¬í˜„ (travel.plan)
- [ ] ë¡œì»¬ í…ŒìŠ¤íŠ¸

*** Phase 3: Meta Agent í†µí•© (2026 Q1)

- [ ] A2A Client êµ¬í˜„
- [ ] Agent Registry
- [ ] Domain Router
- [ ] Intent Analysis
- [ ] End-to-end í…ŒìŠ¤íŠ¸

*** Phase 4: í™•ì¥ (2026 Q2+)

- [ ] ì¶”ê°€ capabilities (finance, education, events)
- [ ] Work-Config Agent ì¶”ê°€
- [ ] Health-Config Agent ì¶”ê°€
- [ ] ë¶„ì‚° ì‹¤í–‰ (ì—¬ëŸ¬ ë¨¸ì‹ )
- [ ] ëª¨ë‹ˆí„°ë§ & ë¡œê¹…

** ğŸ“Š ê¸°ìˆ  ìŠ¤íƒ

*** Family-Config Agent (A2A Server)

#+begin_src yaml
Runtime: Node.js 20+ / Python 3.11+
ì–¸ì–´: TypeScript / Python
ì›¹ í”„ë ˆì„ì›Œí¬: Express / FastAPI
í”„ë¡œí† ì½œ: A2A (JSON-RPC 2.0)
í´ë¼ì´ì–¸íŠ¸: MCP SDK
ë°ì´í„°: Org-mode files (Git)
í¬íŠ¸: 8080
#+end_src

*** Meta Agent (A2A Client)

#+begin_src yaml
ê¸°ì¡´: Claude Code (Anthropic)
í™•ì¥: A2A Client ëª¨ë“ˆ
í”„ë¡œí† ì½œ: 
  - ACP (ì‚¬ìš©ì í†µì‹ )
  - A2A (ë„ë©”ì¸ ì—ì´ì „íŠ¸ í†µì‹ )
#+end_src

*** MCP Tools

#+begin_src yaml
ê¸°ì¡´ MCP ì„œë²„ í™œìš©:
- mcp__web_search
- mcp__n8n
- mcp__playwright
- mcp__git
- mcp__supabase

ì‹ ê·œ êµ¬í˜„ í•„ìš”:
- mcp__google_calendar
- mcp__filesystem (enhanced)
#+end_src

** ğŸ”— ì°¸ê³  ë¬¸ì„œ

- [[file:protocol-standards-analysis.org][Protocol Standards Analysis]]
- [[file:delegation-protocol.org][Delegation Protocol]]
- [[file:~/repos/gh/family-config/FAMILY.md][FAMILY.md]]
- [[file:../README.org][Meta-Config README]]

** ğŸ“ ë¼ì´ì„ ìŠ¤

MIT License

---

**ìƒíƒœ**: ğŸ› ï¸ DESIGN â†’ IMPLEMENTATION  
**ë‹¤ìŒ ë‹¨ê³„**: A2A Server í”„ë¡œí† íƒ€ì… êµ¬í˜„
