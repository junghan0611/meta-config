#+title:      ACP _meta í•„ë“œ í‘œì¤€ ë¶„ì„ - ê³µì‹ vs êµ¬í˜„ì²´ í™•ì¥
#+date:       [2025-11-11 Mon 11:00]
#+filetags:   :solution:acp:protocol:standard:claude_code:
#+identifier: 20251111T110000

* ACP _meta í•„ë“œ í‘œì¤€ ë¶„ì„
:PROPERTIES:
:CUSTOM_ID: acp-meta-í•„ë“œ-í‘œì¤€-ë¶„ì„
:END:

** ğŸ“‹ í•µì‹¬ ë°œê²¬

*_metaëŠ” ACP ê³µì‹ í‘œì¤€ì´ ì•„ë‹Œ claude-code-acpì˜ ë¹„ê³µì‹ í™•ì¥ì…ë‹ˆë‹¤.*

| í•­ëª© | ACP ê³µì‹ í‘œì¤€ | claude-code-acp êµ¬í˜„ |
|------+---------------+---------------------|
| ë©”íƒ€ë°ì´í„° í•„ë“œëª… | =metadata= | =_meta= |
| í‘œì¤€ ì—¬ë¶€ | âœ… ê³µì‹ ìŠ¤í™ | âŒ ë²¤ë” í™•ì¥ |
| ìœ„ì¹˜ | MessagePart ë‚´ë¶€ | Request/Response ë£¨íŠ¸ |
| ìš©ë„ | Citation, Trajectory | systemPrompt, terminal-auth, usage |
| íŒ¨í„´ | ACP í‘œì¤€ | LSPì˜ =x-= íŒ¨í„´ ìœ ì‚¬ |

** ğŸ” ACP ê³µì‹ í‘œì¤€: metadata

*** ì¶œì²˜
- ê³µì‹ ì‚¬ì´íŠ¸: https://agentcommunicationprotocol.dev
- GitHub ì €ì¥ì†Œ: https://github.com/i-am-bee/acp
- ìŠ¤í™: OpenAPI YAML ê¸°ë°˜

*** êµ¬ì¡° (MessagePart)

#+begin_src typescript
interface MessagePart {
  content_type: string;
  content: string | object;
  content_encoding?: string;
  content_url?: string;
  name?: string;
  metadata?: CitationMetadata | TrajectoryMetadata; // ì—¬ê¸°!
}

// ê³µì‹ ë©”íƒ€ë°ì´í„° íƒ€ì…
type CitationMetadata = {
  kind: "citation";
  start_index?: number;
  end_index?: number;
  url?: string;
  title?: string;
  description?: string;
}

type TrajectoryMetadata = {
  kind: "trajectory";
  message?: string;
  tool_name?: string;
  tool_input?: object;
  tool_output?: object;
}
#+end_src

*** íŠ¹ì§•
- *ë©”ì‹œì§€ ë‚´ë¶€* ì—ë§Œ ì¡´ì¬ (MessagePart ë ˆë²¨)
- ì¶œì²˜ ì¶”ì  (Citation) ë˜ëŠ” ì¶”ë¡  ê³¼ì • (Trajectory) ì „ìš©
- ìš”ì²­/ì‘ë‹µ ë£¨íŠ¸ì—ëŠ” ì—†ìŒ

** ğŸš€ claude-code-acp ë¹„ê³µì‹ í™•ì¥: _meta

*** ì¶œì²˜
- íŒ¨í‚¤ì§€: =@zed-industries/claude-code-acp= (npm)
- ì €ì¥ì†Œ: ~/repos/3rd/claude-code-acp/
- ë²„ì „: 0.10.0

*** êµ¬ì¡° (Request/Response ë£¨íŠ¸)

#+begin_src typescript
// ìš”ì²­ ì˜ˆì‹œ (src/acp-agent.ts:116)
interface ClientCapabilities {
  fs?: { readTextFile: boolean };
  terminal?: boolean;
  _meta?: {  // ë¹„ê³µì‹ í™•ì¥!
    "terminal-auth"?: boolean;
  }
}

// ì‘ë‹µ ì˜ˆì‹œ (src/acp-agent.ts:120)
interface AuthMethod {
  id: string;
  name: string;
  description: string;
  _meta?: {  // ë¹„ê³µì‹ í™•ì¥!
    "terminal-auth"?: {
      command: string;
      args: string[];
      label: string;
    }
  }
}

// ì„¸ì…˜ ìƒì„± ì˜ˆì‹œ (src/acp-agent.ts:193)
interface NewSessionRequest {
  cwd: string;
  mcpServers?: McpServer[];
  _meta?: {  // ë¹„ê³µì‹ í™•ì¥!
    systemPrompt?: string | { append: string };
  }
}
#+end_src

*** ì‹¤ì œ ì‚¬ìš© ì½”ë“œ

#+begin_src typescript
// src/acp-agent.ts:116-130
if (request.clientCapabilities?._meta?.["terminal-auth"] === true) {
  const cliPath = import.meta
    .resolve("@anthropic-ai/claude-agent-sdk/cli.js")
    .replace("file://", "");

  authMethod._meta = {
    "terminal-auth": {
      command: "node",
      args: [cliPath, "/login"],
      label: "Claude Code Login",
    },
  };
}

// src/acp-agent.ts:193-205
let systemPrompt: Options["systemPrompt"] = {
  type: "preset",
  preset: "claude_code"
};

if (params._meta?.systemPrompt) {
  const customPrompt = params._meta.systemPrompt;
  if (typeof customPrompt === "string") {
    systemPrompt = customPrompt;
  } else if (
    typeof customPrompt === "object" &&
    "append" in customPrompt &&
    typeof customPrompt.append === "string"
  ) {
    systemPrompt.append = customPrompt.append;
  }
}
#+end_src

** ğŸ¯ ì™œ _metaì¸ê°€?

*** LSP(Language Server Protocol) íŒ¨í„´ ì°¨ìš©

LSPì—ì„œë„ ë²¤ë”ë³„ í™•ì¥ì„ =x-= ì ‘ë‘ì‚¬ë¡œ êµ¬ë¶„:
- =x-vscode-...= (VS Code ì „ìš©)
- =x-eclipse-...= (Eclipse ì „ìš©)

claude-code-acpëŠ” =_meta= ë¥¼ ê°™ì€ ìš©ë„ë¡œ ì‚¬ìš©:
- í‘œì¤€ í˜¸í™˜ì„± ìœ ì§€ (ACP ìŠ¤í™ ìœ„ë°˜ ì—†ìŒ)
- êµ¬í˜„ì²´ë³„ ê¸°ëŠ¥ ì¶”ê°€ (í•˜ìœ„ í˜¸í™˜ì„± ë³´ì¥)
- ë‹¤ë¥¸ ACP í´ë¼ì´ì–¸íŠ¸ëŠ” ë¬´ì‹œ ê°€ëŠ¥

*** ì¥ì 
1. *í‘œì¤€ ê¹¨ì§€ ì•ŠìŒ*: ACP ê³µì‹ ìŠ¤í™ ì¤€ìˆ˜
2. *í™•ì¥ì„±*: ìƒˆ ê¸°ëŠ¥ ììœ ë¡­ê²Œ ì¶”ê°€
3. *í˜¸í™˜ì„±*: ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì— ì˜í–¥ ì—†ìŒ
4. *ìœ ì—°ì„±*: ì‹¤í—˜ì  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

** ğŸ“Š í˜„ì¬ ìƒí™© ì •ë¦¬

*** agent-shell + acp.el
- *_meta ì§€ì› ì—†ìŒ*
- ACP ê³µì‹ í‘œì¤€ë§Œ êµ¬í˜„
- claude-code-acpì˜ í™•ì¥ ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€

*** ê²°ê³¼
- =systemPrompt= ì»¤ìŠ¤í…€ ë¶ˆê°€ (agent-shell-config.el:170 TODO)
- =terminal-auth= ì‚¬ìš© ë¶ˆê°€
- í† í° usage ì •ë³´ ìˆ˜ì‹  ë¶ˆê°€

** ğŸš€ Upstream PR ì „ëµ

*** 1. claude-code-acp (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

*Issue*: "Expose token usage in sessionUpdate _meta field"

*Rationale*:
- í´ë¼ì´ì–¸íŠ¸ê°€ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ í•„ìš”
- ì»´íŒ©íŠ¸ ì‹œì  ì˜ˆì¸¡ìœ¼ë¡œ UX ê°œì„ 
- ê¸°ì¡´ =_meta= íŒ¨í„´ í™•ì¥ë§Œìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥

*PR ì œì•ˆ*:
#+begin_src typescript
// src/acp-agent.ts ìˆ˜ì •
await this.client.sessionUpdate({
  sessionId,
  update: { ... },
  _meta: {  // ì¶”ê°€!
    usage: {
      input_tokens: query.usage.input_tokens,
      output_tokens: query.usage.output_tokens,
      cache_creation_input_tokens: query.usage.cache_creation_input_tokens,
      cache_read_input_tokens: query.usage.cache_read_input_tokens
    },
    model: query.model  // í˜„ì¬ ëª¨ë¸ ID
  }
});
#+end_src

*ì˜ˆìƒ ë¦¬ë·° í¬ì¸íŠ¸*:
- [ ] ê¸°ì¡´ =_meta= íŒ¨í„´ê³¼ ì¼ê´€ì„±
- [ ] ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ ì˜í–¥ ì—†ìŒ (optional)
- [ ] ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ (í† í° ìˆ˜ëŠ” ë¯¼ê° ì •ë³´ ì•„ë‹˜)

*** 2. acp.el (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

*Issue*: "Support _meta field in request builders"

*Rationale*:
- claude-code-acp í™•ì¥ ê¸°ëŠ¥ ì‚¬ìš© ìœ„í•´ í•„ìš”
- ACP í‘œì¤€ ìœ„ë°˜ ì•„ë‹˜ (optional í•„ë“œ)
- ë‹¤ë¥¸ ACP êµ¬í˜„ì²´ë„ =_meta= ì‚¬ìš© ê°€ëŠ¥ì„±

*PR ì œì•ˆ*:
#+begin_src elisp
(cl-defun acp-make-session-new-request (&key cwd mcp-servers _meta)
  "session/new ìš”ì²­ ìƒì„± (_meta ì§€ì› ì¶”ê°€)."
  `((:method . "session/new")
    (:params . ((cwd . ,(expand-file-name cwd))
               (mcpServers . ,(or mcp-servers []))
               ,@(when _meta `((_meta . ,_meta)))))))  ; ì¶”ê°€!

;; sessionUpdate í•¸ë“¤ëŸ¬ì—ë„ _meta ì§€ì›
(defun acp--handle-session-update (notification)
  (let* ((params (map-elt notification :params))
         (session-id (map-elt params :sessionId))
         (update (map-elt params :update))
         (_meta (map-elt params :_meta)))  ; ì¶”ê°€!
    ;; _meta ì²˜ë¦¬ ë¡œì§ (ì½œë°± í˜¸ì¶œ)
    (when _meta
      (run-hook-with-args 'acp-session-meta-hook session-id _meta))))
#+end_src

*ì˜ˆìƒ ë¦¬ë·° í¬ì¸íŠ¸*:
- [ ] ê¸°ì¡´ ACP í´ë¼ì´ì–¸íŠ¸ì™€ í˜¸í™˜ì„±
- [ ] ë¬¸ì„œí™” í•„ìš” (ë¹„ê³µì‹ í™•ì¥ ëª…ì‹œ)
- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€

*** 3. agent-shell (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)

*Issue*: "Document meta-config integration example"

*Rationale*:
- ì»¤ë®¤ë‹ˆí‹°ì— í™•ì¥ ì‚¬ë¡€ ê³µìœ 
- ë‹¤ë¥¸ ì‚¬ìš©ìë„ ì»¤ìŠ¤í…€ í†µí•© ê°€ëŠ¥
- í•œêµ­ì–´ ê°€ì´ë“œ ê¸°ì—¬

*PR ì œì•ˆ*:
- =examples/meta-config-integration.md= ì¶”ê°€
- agent-shell-config.el íŒ¨í„´ ë¬¸ì„œí™”
- ëª¨ë“œë¼ì¸ ì»¤ìŠ¤í…€ ì˜ˆì œ

** ğŸ“Œ í•µì‹¬ í†µì°°

#+begin_quote
"_metaëŠ” ACPì˜ ì§„ì •í•œ í˜ - í‘œì¤€ í˜¸í™˜ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ë¬´í•œ í™•ì¥"
#+end_quote

LSPì˜ ì„±ê³µ ìš”ì¸ ì¤‘ í•˜ë‚˜ëŠ” =x-= í™•ì¥ ë©”ì»¤ë‹ˆì¦˜. claude-code-acpë„ ê°™ì€ íŒ¨í„´ì„ =_meta= ë¡œ êµ¬í˜„.
ì´ì œ meta-configëŠ”:
1. í‘œì¤€ ACP ê¸°ëŠ¥ ì‚¬ìš© (í˜¸í™˜ì„±)
2. =_meta= í™•ì¥ í™œìš© (ì°¨ë³„í™”)
3. Upstream ê¸°ì—¬ (ìƒíƒœê³„ ë°œì „)

** ğŸ”— ì°¸ì¡°

- [[https://agentcommunicationprotocol.dev/core-concepts/message-metadata][ACP ê³µì‹ ë¬¸ì„œ - Message Metadata]]
- [[https://github.com/i-am-bee/acp][ACP ê³µì‹ ì €ì¥ì†Œ]]
- [[file:~/repos/3rd/claude-code-acp/src/acp-agent.ts][claude-code-acp ì†ŒìŠ¤]]
- [[file:~/repos/gh/acp.el/acp.el][acp.el í¬í¬]]
- [[file:20251111T102000--acp-ë©”íƒ€ë°ì´í„°-í™œìš©-ê°€ì´ë“œ__solution_acp_agent_shell.org][ì´ì „ ë¶„ì„ ë¬¸ì„œ]]

** ğŸ“ ë‹¤ìŒ ë‹¨ê³„

1. [ ] claude-code-acp PR ì‘ì„± (usage ì •ë³´ ë…¸ì¶œ)
2. [ ] acp.el PR ì‘ì„± (_meta ì§€ì›)
3. [ ] agent-shell ë¬¸ì„œ ê¸°ì—¬ (ì˜ˆì œ)
4. [ ] meta-config ì™„ì„± í›„ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸

---

*ì‘ì„±*: 2025-11-11 (junghanacs)
*ê¸°ë°˜*: ACP ê³µì‹ ìŠ¤í™ + claude-code-acp v0.10.0 ì†ŒìŠ¤ ë¶„ì„
*ê²°ë¡ *: _metaëŠ” ë²¤ë” í™•ì¥, metadataëŠ” ê³µì‹ í‘œì¤€
