#+title:      ACP ë©”íƒ€ë°ì´í„° í™œìš© ê°€ì´ë“œ - claude-code-acp ë¶„ì„
#+date:       [2025-11-11 Mon 10:20]
#+filetags:   :solution:acp:agent_shell:meta_config:
#+identifier: 20251111T102000

* ACP ë©”íƒ€ë°ì´í„° í™œìš© ê°€ì´ë“œ
:PROPERTIES:
:CUSTOM_ID: acp-ë©”íƒ€ë°ì´í„°-í™œìš©-ê°€ì´ë“œ
:END:

** ğŸ“‹ ìš”ì•½
:PROPERTIES:
:CUSTOM_ID: ìš”ì•½
:END:

claude-code-acp (Zed Industries êµ¬í˜„) ì†ŒìŠ¤ ë¶„ì„ì„ í†µí•´ ACP í”„ë¡œí† ì½œì˜ _meta í™•ì¥ ë©”ì»¤ë‹ˆì¦˜ê³¼
ì‹¤ì œ í™œìš© ë°©ë²•ì„ íŒŒì•…í•¨. agent-shell.el + meta-config í†µí•© ìµœì†Œ êµ¬í˜„ ë°©ì•ˆ ë„ì¶œ.

*í•µì‹¬ ë°œê²¬*:
- ACPì˜ _meta í•„ë“œë¡œ ë¬´ì œí•œ í™•ì¥ ê°€ëŠ¥
- claude-code-acpëŠ” systemPrompt, terminal-auth ë“± í™œìš©
- 5ë¶„ ë‚´ ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥í•œ meta-config í†µí•© ë°©ì•ˆ ì¡´ì¬

** ğŸ¯ claude-code-acp ë¶„ì„ ê²°ê³¼
:PROPERTIES:
:CUSTOM_ID: claude-code-acp-ë¶„ì„-ê²°ê³¼
:END:

*** íŒ¨í‚¤ì§€ êµ¬ì¡° (~/repos/3rd/claude-code-acp/)
:PROPERTIES:
:CUSTOM_ID: íŒ¨í‚¤ì§€-êµ¬ì¡°
:END:

#+begin_example
@zed-industries/claude-code-acp v0.10.0 (TypeScript)
â”œâ”€â”€ @agentclientprotocol/sdk ^0.5.1       # ACP í”„ë¡œí† ì½œ
â”œâ”€â”€ @anthropic-ai/claude-agent-sdk ^0.1.30
â”œâ”€â”€ @anthropic-ai/claude-code ^2.0.32
â””â”€â”€ @modelcontextprotocol/sdk ^1.21.0     # MCP í†µí•©

src/
â”œâ”€â”€ acp-agent.ts      (27KB) â† í•µì‹¬ êµ¬í˜„
â”œâ”€â”€ mcp-server.ts     (23KB)
â”œâ”€â”€ tools.ts          (13KB)
â””â”€â”€ utils.ts          (5KB)
#+end_example

*** _meta í™•ì¥ ì‚¬ìš© ì‚¬ë¡€ (ì‹¤ì œ ì½”ë“œ)
:PROPERTIES:
:CUSTOM_ID: meta-í™•ì¥-ì‚¬ìš©-ì‚¬ë¡€
:END:

#+begin_src typescript
// src/acp-agent.ts:116 - í´ë¼ì´ì–¸íŠ¸ ê¸°ëŠ¥ í™•ì¥
if (request.clientCapabilities?._meta?.["terminal-auth"] === true) {
  authMethod._meta = {
    "cli-path": "/path/to/claude",
    "terminal-auth": true
  }
}

// src/acp-agent.ts:193 - ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
if (params._meta?.systemPrompt) {
  const customPrompt = params._meta.systemPrompt;
  if (typeof customPrompt === "string") {
    systemPrompt = customPrompt;
  } else if ("append" in customPrompt) {
    systemPrompt.append = customPrompt.append;
  }
}
#+end_src

*** session/update ì•Œë¦¼ íƒ€ì…
:PROPERTIES:
:CUSTOM_ID: session-update-ì•Œë¦¼-íƒ€ì…
:END:

| ì•Œë¦¼ íƒ€ì… | ì„¤ëª… | ì½”ë“œ ìœ„ì¹˜ |
|------+------+------|
| available_commands_update | /compact, /model ë“± ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ | :266 |
| current_mode_update | default/bypass ê¶Œí•œ ëª¨ë“œ ë³€ê²½ | :663 |
| tool_call | ë„êµ¬ í˜¸ì¶œ ì‹œì‘ | :514 |
| tool_call_update | ë„êµ¬ ì‹¤í–‰ ìƒíƒœ/ê²°ê³¼ | :595 |
| agent_message_chunk | ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° | :566 |
| agent_thought_chunk | ë‚´ë¶€ ì¶”ë¡  ê³¼ì • | :546 |
| plan | ì‹¤í–‰ ê³„íš í‘œì‹œ | :586 |

** ğŸš€ meta-config í†µí•© ìµœì†Œ êµ¬í˜„
:PROPERTIES:
:CUSTOM_ID: meta-config-í†µí•©-ìµœì†Œ-êµ¬í˜„
:END:

*** ì¦‰ì‹œ ê°€ëŠ¥ (5ë¶„, ì½”ë“œ 20ì¤„)
:PROPERTIES:
:CUSTOM_ID: ì¦‰ì‹œ-ê°€ëŠ¥-5ë¶„
:END:

#+begin_src bash
# ~/repos/gh/meta-config/emacs/agent-shell-config.el
cat > ~/repos/gh/meta-config/emacs/agent-shell-config.el << 'ELISP'
;;; agent-shell-config.el --- meta-config ACP integration

(defun jh/agent-context-indicator ()
  "ë””ë°”ì´ìŠ¤ + Git ë¸Œëœì¹˜ + ì„¸ì…˜ ëª¨ë“œ í‘œì‹œ"
  (concat
   ;; ë””ë°”ì´ìŠ¤
   (when-let ((device (ignore-errors
                       (with-temp-buffer
                         (insert-file-contents "~/.current-device")
                         (string-trim (buffer-string))))))
     (propertize (format "[%s] " device) 'face 'success))
   
   ;; Git ë¸Œëœì¹˜
   (when (and (fboundp 'magit-get-current-branch)
              (magit-get-current-branch))
     (propertize (format "[%s] " (magit-get-current-branch))
                 'face 'font-lock-keyword-face))
   
   ;; ê¸°ì¡´ agent-shell ëª¨ë“œë¼ì¸
   (agent-shell--mode-line-format)))

(with-eval-after-load 'agent-shell
  (add-hook 'agent-shell-mode-hook
            (lambda ()
              (setq-local mode-line-misc-info
                         '((:eval (jh/agent-context-indicator)))))))

(provide 'agent-shell-config)
ELISP

# init.elì— ë¡œë“œ ì¶”ê°€
echo "(require 'agent-shell-config)" >> ~/.emacs.d/init.el
#+end_src

*** ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì£¼ì… (10ë¶„)
:PROPERTIES:
:CUSTOM_ID: ì»¤ìŠ¤í…€-í”„ë¡¬í”„íŠ¸-ì£¼ì…
:END:

#+begin_src elisp
;; acp.elì— _meta ì§€ì› ì¶”ê°€ (upstream PR ëŒ€ìƒ)
(cl-defun acp-make-session-new-request (&key cwd mcp-servers _meta)
  "session/new ìš”ì²­ ìƒì„± (_meta ì§€ì›)"
  `((:method . "session/new")
    (:params . ((cwd . ,(expand-file-name cwd))
               (mcpServers . ,(or mcp-servers []))
               ,@(when _meta `((_meta . ,_meta)))))))

;; meta-config í”„ë¡¬í”„íŠ¸ ì£¼ì…
(defvar jh/agent-custom-prompt
  "ë‹¹ì‹ ì€ NixOSì™€ Emacs ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
í˜„ì¬ ë””ë°”ì´ìŠ¤: %s
ì‘ì—… ì»¨í…ìŠ¤íŠ¸: ~/claude-memory/ Git ì €ì¥ì†Œ
meta-config ìƒíƒœê³„ í†µí•© í•„ìˆ˜")

(defun jh/agent-new-session-with-prompt ()
  "ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ë¡œ ì„¸ì…˜ ì‹œì‘"
  (let ((device (getenv "CURRENT_DEVICE")))
    (acp-send-request
     :client client
     :request (acp-make-session-new-request
               :cwd default-directory
               :_meta `((systemPrompt . ((append . ,(format jh/agent-custom-prompt device)))))))))
#+end_src

*** í† í° ì‚¬ìš©ëŸ‰ ì¶”ì • (íœ´ë¦¬ìŠ¤í‹±)
:PROPERTIES:
:CUSTOM_ID: í† í°-ì‚¬ìš©ëŸ‰-ì¶”ì •
:END:

#+begin_src elisp
(defvar jh/claude-context-window 200000
  "Sonnet 4.5 ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°")

(defun jh/estimate-token-usage ()
  "ë²„í¼ í† í° ìˆ˜ ì¶”ì • ë° ê²½ê³  í‘œì‹œ"
  (when (derived-mode-p 'agent-shell-mode)
    (let* ((content (buffer-string))
           (estimated-tokens (/ (length content) 4))  ; 1í† í° â‰ˆ 4ì
           (ratio (/ (float estimated-tokens) jh/claude-context-window)))
      (cond
       ((> ratio 0.9) (propertize " [ğŸ”´90%+]" 'face 'error))
       ((> ratio 0.8) (propertize " [ğŸŸ¡80%+]" 'face 'warning))
       (t "")))))
#+end_src

** ğŸ“Š ì‹¤í˜„ ê°€ëŠ¥ì„± ë§¤íŠ¸ë¦­ìŠ¤
:PROPERTIES:
:CUSTOM_ID: ì‹¤í˜„-ê°€ëŠ¥ì„±-ë§¤íŠ¸ë¦­ìŠ¤
:END:

| ê¸°ëŠ¥ | í˜„ì¬ | ì¦‰ì‹œ(5ë¶„) | ë‹¨ê¸°(1ì£¼) | Upstream | ë¹„ê³  |
|------+------+----------+----------+----------+------|
| ë””ë°”ì´ìŠ¤ í‘œì‹œ | âŒ | âœ… | - | - | ~/.current-device |
| Git ë¸Œëœì¹˜ | âŒ | âœ… | - | - | magit ì—°ë™ |
| ì„¸ì…˜ ëª¨ë“œ | âœ… | âœ… | - | - | ACP í‘œì¤€ |
| ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ | âŒ | - | âœ… | ğŸŸ¡ | acp.el PR |
| í† í° ì¶”ì • | âŒ | ğŸŸ¡ | âœ… | - | íœ´ë¦¬ìŠ¤í‹± |
| í† í° ì •í™•ê°’ | âŒ | - | - | âœ… | claude-code-acp PR |
| ì»´íŒ©íŠ¸ ì‹œì  | âŒ | - | - | âœ… | /compact ëª…ë ¹ |
| ëª¨ë¸ ì •ë³´ | âŒ | - | - | âœ… | _meta ì‘ë‹µ |

*ë²”ë¡€*:
- âœ… = ì™„ì „ êµ¬í˜„ ê°€ëŠ¥
- ğŸŸ¡ = ë¶€ë¶„ êµ¬í˜„ / ì œí•œì 
- âŒ = ë¶ˆê°€ëŠ¥

** ğŸ¯ Upstream ê¸°ì—¬ ë¡œë“œë§µ
:PROPERTIES:
:CUSTOM_ID: upstream-ê¸°ì—¬-ë¡œë“œë§µ
:END:

*** claude-code-acp (ìš°ì„ ìˆœìœ„ 1)
:PROPERTIES:
:CUSTOM_ID: claude-code-acp-pr
:END:

*Issue*: "Add usage metrics to _meta field in sessionUpdate"

*Rationale*:
- í´ë¼ì´ì–¸íŠ¸ê°€ ì»¨í…ìŠ¤íŠ¸ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ í•„ìš”
- ì»´íŒ©íŠ¸ ì‹œì  ì˜ˆì¸¡ìœ¼ë¡œ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- ACP í‘œì¤€ í˜¸í™˜ì„± ìœ ì§€ (_meta í™œìš©)

*PR ì œì•ˆ*:
#+begin_src typescript
// src/acp-agent.ts ìˆ˜ì •
await this.client.sessionUpdate({
  sessionId,
  update: { ... },
  _meta: {
    usage: {
      input_tokens: query.usage.input_tokens,
      output_tokens: query.usage.output_tokens,
      cache_creation_input_tokens: query.usage.cache_creation_input_tokens,
      cache_read_input_tokens: query.usage.cache_read_input_tokens
    },
    model: query.model  // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸ ID
  }
});
#+end_src

*** acp.el (ìš°ì„ ìˆœìœ„ 2)
:PROPERTIES:
:CUSTOM_ID: acp-el-pr
:END:

*Issue*: "Support _meta field in request builders"

*PR*:
#+begin_src elisp
(cl-defun acp-make-session-new-request (&key cwd mcp-servers _meta)
  `((:method . "session/new")
    (:params . ((cwd . ,(expand-file-name cwd))
               (mcpServers . ,(or mcp-servers []))
               ,@(when _meta `((_meta . ,_meta)))))))
#+end_src

*** agent-shell (ìš°ì„ ìˆœìœ„ 3)
:PROPERTIES:
:CUSTOM_ID: agent-shell-pr
:END:

*Documentation*:
- meta-config í†µí•© ì‚¬ë¡€ ë¬¸ì„œí™”
- í•œêµ­ì–´ ê°€ì´ë“œ ê¸°ì—¬
- _meta í•¸ë“¤ë§ ì˜ˆì œ ì½”ë“œ

** ğŸ”— ì°¸ì¡°
:PROPERTIES:
:CUSTOM_ID: ì°¸ì¡°
:END:

- [[file:~/repos/3rd/claude-code-acp/src/acp-agent.ts][claude-code-acp ì†ŒìŠ¤]]
- [[file:~/repos/gh/agent-shell/agent-shell.el][agent-shell í¬í¬]]
- [[file:~/repos/gh/acp.el/acp.el][acp.el í¬í¬]]
- [[file:~/claude-memory/areas/20250926T130000--acp-mcp-í”„ë¡œí† ì½œ-íŒ¨ëŸ¬ë‹¤ì„-ì „í™˜__agent_protocol_architecture.org][ACP vs MCP ë¬¸ì„œ]]

** ğŸ“Œ í•µì‹¬ í†µì°°
:PROPERTIES:
:CUSTOM_ID: í•µì‹¬-í†µì°°
:END:

#+begin_quote
"_meta í•„ë“œê°€ ACPì˜ ì§„ì •í•œ í˜ - í‘œì¤€ í”„ë¡œí† ì½œ í˜¸í™˜ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ë¬´í•œ í™•ì¥"
#+end_quote

claude-code-acp ë¶„ì„ì„ í†µí•´ ë°œê²¬: _metaë¡œ í‘œì¤€ì„ ê¹¨ì§€ ì•Šê³  êµ¬í˜„ì²´ë³„ ê¸°ëŠ¥ ì¶”ê°€ ê°€ëŠ¥.
ì´ëŠ” LSPì˜ ì„±ê³µ íŒ¨í„´ê³¼ ë™ì¼í•œ ì ‘ê·¼ ë°©ì‹.

--------------

*ì‘ì„±*: 2025-11-11 (junghanacs)
*ê¸°ë°˜*: claude-code-acp v0.10.0 ì†ŒìŠ¤ ë¶„ì„
*ë‹¤ìŒ ë‹¨ê³„*: meta-config/emacs/agent-shell-config.el ìƒì„±
