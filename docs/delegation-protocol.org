#+title:      Delegation Protocol: Agent ê°„ ìœ„ì„ í”„ë¡œí† ì½œ
#+date:       [2025-10-14 Mon 13:40]
#+filetags:   :meta:agent:protocol:delegation:
#+identifier: 20251014T134000
#+export_file_name: 20251014T134000-delegation-protocol.md

* Delegation Protocol: Agent ê°„ ìœ„ì„ í”„ë¡œí† ì½œ

**ë²„ì „**: 1.0.0  
**ìƒíƒœ**: ğŸ”¬ DRAFT  
**ì—…ë°ì´íŠ¸**: 2025-10-14

#+begin_quote
"Clear contracts between agents enable autonomous collaboration"
"ëª…í™•í•œ ê³„ì•½ì€ ììœ¨ì  í˜‘ì—…ì„ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤"
#+end_quote

** ğŸ¯ í”„ë¡œí† ì½œ ê°œìš”

*** ëª©ì 

Meta Agentì™€ Domain Agent ê°„ì˜ í†µì‹ ì„ í‘œì¤€í™”í•˜ì—¬:
- ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬
- íƒ€ì… ì•ˆì „ì„± ë³´ì¥
- ì—ëŸ¬ ì²˜ë¦¬ ì¼ê´€ì„±
- í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜
- ë…ë¦½ì  ì—ì´ì „íŠ¸ ê°œë°œ

*** í•µì‹¬ ì›ì¹™

1. **Explicit > Implicit**: ëª¨ë“  ê²ƒì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜
2. **Typed**: YAML ìŠ¤í‚¤ë§ˆë¡œ íƒ€ì… ë³´ì¥
3. **Versioned**: í”„ë¡œí† ì½œ ë²„ì „ ê´€ë¦¬
4. **Asynchronous**: ë¹„ë™ê¸° ì‘ì—… ì§€ì›
5. **Idempotent**: ë™ì¼ ìš”ì²­ì€ ë™ì¼ ê²°ê³¼
6. **Traceable**: ëª¨ë“  ì‘ì—… ì¶”ì  ê°€ëŠ¥

*** í†µì‹  íë¦„

#+begin_src
[Meta Agent]
      â†“ 1. Delegation Request
[Domain Agent]
      â†“ 2. Acknowledgment (ì¦‰ì‹œ)
      â†“ 3. Processing...
      â†“ 4. Progress Updates (ì„ íƒ)
      â†“ 5. Delegation Response
[Meta Agent]
      â†“ 6. Result Integration
[User]
#+end_src

** ğŸ“‹ ë©”ì‹œì§€ í˜•ì‹

*** 1. Delegation Request (ìœ„ì„ ìš”ì²­)

**** ê¸°ë³¸ êµ¬ì¡°

#+begin_src yaml
delegation:
  # === ë©”íƒ€ë°ì´í„° ===
  version: "1.0.0"              # í”„ë¡œí† ì½œ ë²„ì „
  request_id: "req_20251014_001"  # ê³ ìœ  ìš”ì²­ ID
  timestamp: "2025-10-14T13:40:00+09:00"  # ìš”ì²­ ì‹œê°
  
  # === ì—ì´ì „íŠ¸ ì •ë³´ ===
  source:
    agent: "meta-agent"
    version: "3.2.0"
    instance_id: "meta_001"
  
  target:
    agent: "family-config"      # ëŒ€ìƒ ì—ì´ì „íŠ¸
    version: "1.0.0"            # í˜¸í™˜ ë²„ì „
    instance_id: null           # null = ìƒˆ ì¸ìŠ¤í„´ìŠ¤
  
  # === ì‘ì—… ì •ì˜ ===
  task:
    type: "family.travel.plan"  # ì‘ì—… íƒ€ì… (ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
    priority: "high"            # low | normal | high | urgent
    deadline: "2025-04-30T23:59:59+09:00"  # ì„ íƒì 
    timeout: 300                # ì´ˆ ë‹¨ìœ„ (null = ë¬´ì œí•œ)
    
    # ì‘ì—… ì»¨í…ìŠ¤íŠ¸
    context:
      destination: "ì œì£¼ë„"
      start_date: "2025-07-20"
      end_date: "2025-07-27"
      budget: 3000000
      participants:
        - role: "dad"
          name: "ê¹€ì •í•œ"
        - role: "mom"
          name: "ë°•ì§€ì—°"
        - role: "child1"
          age: 8
          special_needs: []
        - role: "child2"
          age: 5
          special_needs: []
    
    # ì‘ì—… ì„ í˜¸ë„
    preferences:
      accommodation_type: "ê°€ì¡± ì¹œí™”ì  ë¦¬ì¡°íŠ¸"
      activities: ["ìì—° ì²´í—˜", "ë¬¸í™” ê´€ê´‘", "í•´ìˆ˜ìš•"]
      dietary_restrictions: []
      accessibility_required: false
    
    # ì‘ì—… ì œì•½ì‚¬í•­
    constraints:
      must_have: ["ì£¼ì°¨ ê°€ëŠ¥", "ì¡°ì‹ í¬í•¨"]
      must_not_have: ["í¡ì—° ì‹œì„¤"]
      budget_hard_limit: true   # true = ì´ˆê³¼ ë¶ˆê°€
  
  # === ì¶œë ¥ ìš”êµ¬ì‚¬í•­ ===
  output:
    format: "org_file"          # org_file | json | yaml
    location: "~/org/family/travel/"
    filename_pattern: "{date}-{destination}.org"
    include_metadata: true
    include_alternatives: true  # ëŒ€ì•ˆ ì˜µì…˜ í¬í•¨
    
  # === ì•Œë¦¼ ì„¤ì • ===
  notifications:
    on_start: true              # ì‹œì‘ ì‹œ ì•Œë¦¼
    on_progress: true           # ì§„í–‰ ì¤‘ ì—…ë°ì´íŠ¸
    on_complete: true           # ì™„ë£Œ ì‹œ ì•Œë¦¼
    on_error: true              # ì—ëŸ¬ ì‹œ ì•Œë¦¼
    
  # === ì˜ì¡´ì„± ===
  dependencies:                 # ì„ íƒì 
    requires:                   # í•„ìš”í•œ ë°ì´í„°/ì„œë¹„ìŠ¤
      - "google_calendar_access"
      - "travel_budget_approved"
    blocks: []                  # ì´ ì‘ì—…ì´ ì°¨ë‹¨í•˜ëŠ” ê²ƒ
    blocked_by: []              # ì´ ì‘ì—…ì„ ì°¨ë‹¨í•˜ëŠ” ê²ƒ
#+end_src

**** í•„ìˆ˜ í•„ë“œ

ìµœì†Œ ìš”êµ¬ì‚¬í•­:
#+begin_src yaml
delegation:
  version: "1.0.0"
  request_id: "unique_id"
  target:
    agent: "domain-agent"
  task:
    type: "domain.action.verb"
#+end_src

*** 2. Acknowledgment (ìˆ˜ì‹  í™•ì¸)

Domain Agentê°€ ìš”ì²­ì„ ë°›ì•˜ìŒì„ ì¦‰ì‹œ í™•ì¸:

#+begin_src yaml
acknowledgment:
  request_id: "req_20251014_001"
  status: "accepted"            # accepted | rejected
  estimated_duration: 45        # ì´ˆ ë‹¨ìœ„ ì˜ˆìƒ ì‹œê°„
  agent_instance_id: "family_001"
  message: "Travel planning task accepted"
  
  # rejectedì¸ ê²½ìš°
  rejection_reason: null        # "unsupported_task_type" | "resource_unavailable" | ...
#+end_src

*** 3. Progress Update (ì§„í–‰ ìƒí™©)

ì¥ê¸° ì‹¤í–‰ ì‘ì—…ì˜ ê²½ìš° ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸:

#+begin_src yaml
progress:
  request_id: "req_20251014_001"
  timestamp: "2025-10-14T13:40:30+09:00"
  status: "in_progress"
  percent_complete: 60          # 0-100
  current_step: "searching_accommodations"
  steps_completed: ["flights_searched", "budget_calculated"]
  steps_remaining: ["activities_planned", "itinerary_generated"]
  
  message: "Found 12 accommodation options, filtering..."
  
  # ë¶€ë¶„ ê²°ê³¼ (ì„ íƒì )
  partial_results:
    flights_found: 5
    best_flight_price: 680000
#+end_src

*** 4. Delegation Response (ìœ„ì„ ì‘ë‹µ)

ì‘ì—… ì™„ë£Œ í›„ ìµœì¢… ì‘ë‹µ:

#+begin_src yaml
result:
  # === ë©”íƒ€ë°ì´í„° ===
  request_id: "req_20251014_001"
  response_id: "res_20251014_001"
  timestamp: "2025-10-14T13:45:00+09:00"
  agent_instance_id: "family_001"
  
  # === ìƒíƒœ ===
  status: "success"             # success | partial_success | failure
  execution_time: 45            # ì´ˆ
  
  # === ê²°ê³¼ ì¶œë ¥ ===
  output:
    file_path: "~/org/family/travel/20250720-jeju.org"
    format: "org"
    size_bytes: 15420
    checksum: "sha256:abc123..."
    
  # === ìš”ì•½ ===
  summary:
    flights_found: 5
    flights_best_price: 680000
    accommodations_found: 12
    accommodations_recommended: "ííŠ¼ ì œì£¼ ë¦¬ì¡°íŠ¸"
    total_budget_estimated: 2850000
    budget_status: "within_limit"  # within_limit | over_limit
    days_planned: 7
    activities_planned: 15
    
  # === ë‹¤ìŒ ì•¡ì…˜ ===
  next_actions:
    - action: "book_flight"
      priority: "high"
      deadline: "2025-04-30T23:59:59+09:00"
      estimated_cost: 680000
      requires_approval: true
    - action: "book_accommodation"
      priority: "high"
      deadline: "2025-05-15T23:59:59+09:00"
      estimated_cost: 1400000
      requires_approval: true
    - action: "book_rental_car"
      priority: "normal"
      deadline: "2025-06-01T23:59:59+09:00"
      estimated_cost: 420000
      requires_approval: false
  
  # === ëŒ€ì•ˆ ì˜µì…˜ (ìš”ì²­ ì‹œ) ===
  alternatives:
    - option_id: "alt_001"
      description: "ì €ê°€ ì˜µì…˜ (í˜¸ìŠ¤í…”)"
      total_cost: 2100000
      pros: ["ì €ë ´", "ì¤‘ì‹¬ê°€ ìœ„ì¹˜"]
      cons: ["ì‹œì„¤ ë‚¡ìŒ", "ì•„ì´ ì¹œí™”ì  ì•„ë‹˜"]
    - option_id: "alt_002"
      description: "ëŸ­ì…”ë¦¬ ì˜µì…˜ (ì‹ ë¼í˜¸í…”)"
      total_cost: 4500000
      pros: ["ìµœê³ ê¸‰ ì‹œì„¤", "í‚¤ì¦ˆí´ëŸ½"]
      cons: ["ì˜ˆì‚° ì´ˆê³¼ 50%"]
  
  # === ë©”íƒ€ë°ì´í„° ===
  metadata:
    mcp_calls: 8                # MCP ë„êµ¬ í˜¸ì¶œ íšŸìˆ˜
    mcp_tools_used: ["web_search", "calendar"]
    tokens_used: 1200           # AI í† í° ì‚¬ìš©ëŸ‰
    templates_used: ["trip-planning.org"]
    patterns_matched: ["jeju", "family-4", "summer"]
    data_sources: ["google_flights", "booking.com", "airbnb"]
  
  # === ê²½ê³  ë° ê¶Œì¥ì‚¬í•­ ===
  warnings: []                  # ë¬¸ì œ ì—†ìŒ
  recommendations:
    - "í•­ê³µê¶Œì€ ì§€ê¸ˆ ì˜ˆì•½í•˜ë©´ 20% ì €ë ´í•©ë‹ˆë‹¤"
    - "ì„±ìˆ˜ê¸°ì´ë¯€ë¡œ ìˆ™ë°•ì€ 5ì›” ì „ì— ì˜ˆì•½ ê¶Œì¥"
#+end_src

*** 5. Error Response (ì—ëŸ¬ ì‘ë‹µ)

ì‘ì—… ì‹¤íŒ¨ ì‹œ:

#+begin_src yaml
error:
  request_id: "req_20251014_001"
  error_id: "err_20251014_001"
  timestamp: "2025-10-14T13:42:00+09:00"
  
  # === ì—ëŸ¬ ì •ë³´ ===
  code: "E_MCP_TIMEOUT"         # ì—ëŸ¬ ì½”ë“œ (ì•„ë˜ ì°¸ì¡°)
  message: "MCP web_search tool timed out after 30s"
  severity: "high"              # low | medium | high | critical
  
  # === ì»¨í…ìŠ¤íŠ¸ ===
  context:
    task_type: "family.travel.plan"
    current_step: "searching_flights"
    progress_percent: 30
  
  # === ë³µêµ¬ ê°€ëŠ¥ì„± ===
  recoverable: true
  retry_recommended: true
  retry_after: 60               # ì´ˆ (ì¬ì‹œë„ ê¶Œì¥ ì‹œê°„)
  max_retries: 3
  
  # === ë¶€ë¶„ ê²°ê³¼ ===
  partial_results:
    completed_steps: ["budget_calculated"]
    available_data:
      budget_breakdown: "~/tmp/budget_001.json"
  
  # === ì—ëŸ¬ ì„¸ë¶€ì‚¬í•­ ===
  details:
    mcp_tool: "web_search"
    query: "flights to jeju 2025-07-20"
    timeout: 30
    attempts: 2
  
  # === ì œì•ˆ ===
  suggestions:
    - "ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸ í•„ìš”"
    - "MCP timeout ì„¤ì •ì„ 60ì´ˆë¡œ ì¦ê°€ ê¶Œì¥"
    - "ëŒ€ì²´ ë°ì´í„° ì†ŒìŠ¤ ì‚¬ìš© ê°€ëŠ¥ (í•­ê³µì‚¬ ì§ì ‘ ì¡°íšŒ)"
#+end_src

** ğŸ”¢ ìƒíƒœ ì½”ë“œ

*** Success ì½”ë“œ (2xx)

| ì½”ë“œ | ì´ë¦„ | ì„¤ëª… |
|------|------|------|
| 200 | SUCCESS | ì‘ì—… ì™„ë£Œ |
| 201 | PARTIAL_SUCCESS | ì¼ë¶€ë§Œ ì™„ë£Œ |
| 202 | ACCEPTED | ì‘ì—… ìˆ˜ë½ë¨ (ë¹„ë™ê¸°) |

*** Client Error (4xx)

| ì½”ë“œ | ì´ë¦„ | ì„¤ëª… |
|------|------|------|
| 400 | INVALID_REQUEST | ì˜ëª»ëœ ìš”ì²­ í˜•ì‹ |
| 404 | TASK_NOT_FOUND | ì§€ì›í•˜ì§€ ì•ŠëŠ” ì‘ì—… íƒ€ì… |
| 408 | TIMEOUT | ì‘ì—… íƒ€ì„ì•„ì›ƒ |
| 409 | CONFLICT | ì¶©ëŒí•˜ëŠ” ì‘ì—… ì¡´ì¬ |

*** Server Error (5xx)

| ì½”ë“œ | ì´ë¦„ | ì„¤ëª… |
|------|------|------|
| 500 | INTERNAL_ERROR | ë‚´ë¶€ ì˜¤ë¥˜ |
| 503 | UNAVAILABLE | ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€ |
| 504 | MCP_TIMEOUT | MCP ë„êµ¬ íƒ€ì„ì•„ì›ƒ |

** ğŸ”„ ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬

*** Long-Running Tasks

ì¥ê¸° ì‹¤í–‰ ì‘ì—…ì€ ì¦‰ì‹œ ìˆ˜ë½í•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰:

#+begin_src
1. Request â†’ Acknowledgment (ì¦‰ì‹œ, <1ì´ˆ)
2. Progress Updates (ì£¼ê¸°ì , 10-30ì´ˆë§ˆë‹¤)
3. Final Response (ì™„ë£Œ ì‹œ)
#+end_src

*** Polling vs Push

*Polling* (Meta Agentê°€ ìƒíƒœ ì¡°íšŒ):
#+begin_src yaml
status_query:
  request_id: "req_20251014_001"
#+end_src

*Push* (Domain Agentê°€ ìë™ ì—…ë°ì´íŠ¸):
#+begin_src yaml
# Progress update (ìë™ ì „ì†¡)
progress:
  request_id: "req_20251014_001"
  percent_complete: 75
#+end_src

** ğŸ›¡ï¸ ì—ëŸ¬ ì²˜ë¦¬

*** Retry ì „ëµ

#+begin_src yaml
retry_policy:
  max_attempts: 3
  backoff: "exponential"        # linear | exponential
  initial_delay: 5              # ì´ˆ
  max_delay: 60                 # ì´ˆ
  retry_on_codes: [408, 503, 504]
#+end_src

*** Circuit Breaker

ì—°ì† ì‹¤íŒ¨ ì‹œ ì¼ì‹œì ìœ¼ë¡œ ìš”ì²­ ì°¨ë‹¨:

#+begin_src yaml
circuit_breaker:
  failure_threshold: 5          # ì—°ì† 5íšŒ ì‹¤íŒ¨
  timeout: 300                  # 5ë¶„ ë™ì•ˆ ì°¨ë‹¨
  half_open_requests: 1         # í…ŒìŠ¤íŠ¸ ìš”ì²­ 1ê°œ í—ˆìš©
#+end_src

** ğŸ” ë³´ì•ˆ ë° ì¸ì¦

*** Agent Identity

ê° ì—ì´ì „íŠ¸ëŠ” ê³ ìœ  ì‹ë³„ì:

#+begin_src yaml
agent_identity:
  agent_id: "family-config-001"
  agent_type: "family-config"
  version: "1.0.0"
  certificate: "-----BEGIN CERTIFICATE-----..."  # ì„ íƒì 
#+end_src

*** Authorization

ì‘ì—…ë³„ ê¶Œí•œ í™•ì¸:

#+begin_src yaml
authorization:
  required_permissions:
    - "family.travel.read"
    - "family.travel.write"
    - "mcp.web_search.execute"
  granted_by: "meta-agent"
  expires_at: "2025-10-15T00:00:00+09:00"
#+end_src

** ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

*** Timeouts

| ì‘ì—… ìœ í˜• | ê¶Œì¥ Timeout |
|-----------|--------------|
| ë‹¨ìˆœ ì¡°íšŒ | 5-10ì´ˆ |
| ê²€ìƒ‰/ë¶„ì„ | 30-60ì´ˆ |
| ë³µì¡í•œ ê³„íš | 60-300ì´ˆ |
| ë°±ê·¸ë¼ìš´ë“œ | ë¬´ì œí•œ |

*** Rate Limiting

#+begin_src yaml
rate_limit:
  requests_per_minute: 10
  concurrent_requests: 3
  burst_size: 5
#+end_src

** ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

*** ìš”ì²­ ê²€ì¦

#+begin_src python
def validate_delegation_request(request):
    """Delegation request ìœ íš¨ì„± ê²€ì¦"""
    assert request['version'] == "1.0.0"
    assert 'request_id' in request
    assert 'target' in request
    assert 'task' in request
    assert 'type' in request['task']
    # ...
#+end_src

*** Mock Agent

í…ŒìŠ¤íŠ¸ìš© Mock Domain Agent:

#+begin_src yaml
mock_agent:
  behavior: "success"           # success | failure | timeout | slow
  delay: 2                      # ì´ˆ
  error_rate: 0.1               # 10% ì—ëŸ¬ ë°œìƒ
#+end_src

** ğŸ”— ì°¸ê³  ë¬¸ì„œ

- [[file:task-types.org][Task Types: ì‘ì—… íƒ€ì… ì •ì˜]]
- [[file:../schemas/delegation-request.yaml][delegation-request.yaml ìŠ¤í‚¤ë§ˆ]]
- [[file:../schemas/delegation-response.yaml][delegation-response.yaml ìŠ¤í‚¤ë§ˆ]]
- [[file:../README.org][Meta-Config: ê³„ì¸µì  ì—ì´ì „íŠ¸ ì•„í‚¤í…ì²˜]]

** ğŸ“ ë³€ê²½ ì´ë ¥

*** v1.0.0 (2025-10-14)
- Initial protocol definition
- Request/Response í˜•ì‹ ì •ì˜
- ì—ëŸ¬ ì²˜ë¦¬ í‘œì¤€í™”
- ë¹„ë™ê¸° ì‘ì—… ì§€ì›

---

**ìƒíƒœ**: ğŸ”¬ DRAFT - í”¼ë“œë°± í™˜ì˜  
**ë‹¤ìŒ ë‹¨ê³„**: ì‹¤ì œ êµ¬í˜„ ë° ê²€ì¦
